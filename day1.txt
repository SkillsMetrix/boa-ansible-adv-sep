- name: Deploy Nginx with facts and variables
  hosts: webservers
  gather_facts: yes

  vars:
    nginx_port: 8080
    app_name: "MyWebApp"

  tasks:
    # 1. Show gathered fact
    - name: Show OS Family
      debug:
        msg: "This server is running on {{ ansible_os_family }}"

    # 2. Use custom fact
    - name: Show environment from custom fact
      debug:
        msg: "Environment is {{ ansible_local.myapp.environment }} with App version {{ ansible_local.myapp.app_version }}"

    # 3. Install nginx differently depending on OS fact
    - name: Install nginx on Debian/Ubuntu
      apt:
        name: nginx
        state: present
      when: ansible_os_family == "Debian"

    - name: Install nginx on RHEL/CentOS
      yum:
        name: nginx
        state: present
      when: ansible_os_family == "RedHat"

    # 4. Configure nginx using playbook variable
    - name: Create nginx config
      copy:
        dest: /etc/nginx/conf.d/{{ app_name }}.conf
        content: |
          server {
              listen {{ nginx_port }};
              location / {
                  root /var/www/html;
                  index index.html;
              }
          }
      notify: Restart nginx

    # 5. Create an index.html that uses custom fact + vars
    - name: Create index.html
      copy:
        dest: /var/www/html/index.html
        content: |
          <html>
            <h1>Welcome to {{ app_name }}</h1>
            <p>Running in {{ ansible_local.myapp.environment }} environment</p>
            <p>App version: {{ ansible_local.myapp.app_version }}</p>
            <p>Server OS: {{ ansible_distribution }} {{ ansible_distribution_version }}</p>
          </html>

  handlers:
    - name: Restart nginx
      service:
        name: nginx
        state: restarted

---
- name: Deploy FastAPI with async + health check
  hosts: appservers
  become: yes
  tasks:
    - name: Copy FastAPI app
      copy:
        src: ./fastapi_app/
        dest: /opt/fastapi_app/
        mode: 0755

    - name: Restart FastAPI in background
      service:
        name: fastapi
        state: restarted
      async: 300   # allow up to 5 mins
      poll: 0      # run in background
      register: fastapi_job

    - name: Wait until FastAPI is alive
      uri:
        url: "http://{{ inventory_hostname }}:8000/health"
        method: GET
        status_code: 200
      register: result
      until: result.status == 200
      retries: 15     # try 15 times
      delay: 10       # wait 10s between tries

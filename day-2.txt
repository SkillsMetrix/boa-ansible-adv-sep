
- name: configure Jinja2 Template
  hosts: web
  become: yes
  vars_files:
    - vars/main.yaml
  
  tasks:
    - name: Install Nginx
      apt:
        name: nginx
        state: present

    - name: copy jinja2 template to desitnation
      template:
        src: templates/nginx.conf.j2
        dest: /etc/nginx/nginx.conf
        owner: root
        group: root
        mode: '0644'
    
    - name: Restart NGINX
      service:
        name: nginx
        state: started


------------


env: staging
upstream_servers:
  - name: app1
    ip: 10.0.0.10
  - name: app2
    ip: 10.0.0.20


-----


# Generated by Ansible

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    upstream backend {
        {% for server in upstream_servers %}
        server {{ server.ip }}:80 max_fails=3 fail_timeout=30s;
        {% endfor %}
    }

    server {
        listen 80;
        server_name {{ server_name | default("localhost") }};

        location / {
            proxy_pass http://backend;
        }

        {% if environment == 'production' %}
        access_log /var/log/nginx/prod_access.log;
        error_log /var/log/nginx/prod_error.log;
        {% else %}
        access_log /var/log/nginx/stage_access.log;
        error_log /var/log/nginx/stage_error.log;
        {% endif %}
    }
}
